name = "scanner-safe-links"
main = "src/worker.ts"
compatibility_date = "2026-01-23"

[durable_objects]
bindings = [
  { name = "LINK_GUARD", class_name = "LinkGuardDO" },
  { name = "SITES", class_name = "SitesDO" },
  { name = "REDEMPTION_PERMIT", class_name = "RedemptionPermitDO" },
  { name = "INTENT_NONCE", class_name = "IntentNonceDO" },
  { name = "TENANT_CONFIG", class_name = "TenantConfigDO" },
  { name = "TOKEN_REFRESH_MUTEX", class_name = "TokenRefreshMutexDO" }
]

[[d1_databases]]
binding = "EIG_DB"
database_name = "eig-db"
database_id = "52a70cb9-8ca6-46bc-bb36-1d1b1037335c"
preview_database_id = "52a70cb9-8ca6-46bc-bb36-1d1b1037335c"

[vars]
ORIGIN_BASE_URL = "http://127.0.0.1:8787"
TURNSTILE_ENABLED = "false"
TURNSTILE_SITE_KEY = ""
TURNSTILE_SECRET_KEY = ""
PATH_ALLOWLIST = "/auth,/reset,/verify,/invite,/magic"
QUERY_ALLOWLIST = "token,type,redirect_to,next,state"
# Rail: do NOT set ALLOWED_DEST_HOSTS here in production. Set via Secrets. For local smoke, use .dev.vars with ALLOWED_DEST_HOSTS=example.com

# Production: Worker on go.suqram.com. zone_name = apex zone in Cloudflare (suqram.com); pattern = subdomain + path (go.suqram.com/*).
[[routes]]
pattern = "go.suqram.com/*"
zone_name = "suqram.com"

[[migrations]]
tag = "v1"
new_sqlite_classes = ["LinkGuardDO"]

[[migrations]]
tag = "v2"
new_sqlite_classes = ["SitesDO"]

[[migrations]]
tag = "v3"
new_sqlite_classes = ["IntentNonceDO", "TenantConfigDO"]

[[migrations]]
tag = "v4"
new_sqlite_classes = ["TokenRefreshMutexDO"]

[[migrations]]
tag = "v5"
new_sqlite_classes = ["RedemptionPermitDO"]
